@{
  ViewData["Title"] = "Pending Activities";
}

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient text-center py-4"
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h2 class="mb-0 fw-bold">
            <i class="bi bi-clock-history me-2"></i>Pending Activities
          </h2>
        </div>
        <div class="card-body p-4">
          <div class="mb-3 d-flex justify-content-between align-items-center">
            <a asp-action="BioPunchSimulate" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>Back to Punch
            </a>
            <div class="d-flex gap-2 align-items-center">

              <button id="nextBtn" class="btn btn-secondary" disabled>
                Next<i class="bi bi-chevron-right ms-1"></i>
              </button>
              <button id="refreshBtn" class="btn btn-primary">
                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
              </button>
            </div>
          </div>
          <div id="pending-activities-table"></div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

  <script>
    $(document).ready(function () {
      const pageSize = 100;
      let lastResponse = null;
      let cursor = null;
      const nextBtn = document.getElementById('nextBtn');
      const refreshBtn = document.getElementById('refreshBtn');

      // Initialize Tabulator
      const table = new Tabulator("#pending-activities-table", {
        layout: "fitColumns",
        columns: [
          {
            title: "ID",
            field: "id",
            width: 100,
            hozAlign: "center",
            headerHozAlign: "center"
          },
          {
            title: "Proxy Code",
            field: "proxyCode",
            hozAlign: "left",
            headerHozAlign: "center"
          },
          {
            title: "UTC Timestamp",
            field: "timestamp",
            hozAlign: "center",
            headerHozAlign: "center",
            formatter: function (cell) {
              const value = cell.getValue();
              if (value) {
                const date = new Date(value);
                return date.toLocaleString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: true
                });
              }
              return '';
            }
          },
        ],
        placeholder: "No Pending Activities",
        height: "500px",
        ajaxURL: "@Url.Action("GetUnprocessedActivities", "Activity")",
        ajaxConfig: "GET",
        ajaxParams: function () {
          const p = {
            limit: pageSize
          };

          if (cursor !== null) {
            Object.assign(p, {cursor: cursor});
          } else {
            delete p["cursor"];
          }

          return p;
        },
        ajaxResponse: function (url, params, response) {
          lastResponse = response;
          nextBtn.disabled = !(response?.hasMore ?? false);
          return response?.payload ?? [];
        },
      });
      
      nextBtn.addEventListener('click', function () {
        cursor = lastResponse?.hasMore ?? null;
        table.setData();
      });

      refreshBtn.addEventListener('click', function () {
        cursor = null; // Reset to first page
        table.setData();
      });

    });
  </script>
}