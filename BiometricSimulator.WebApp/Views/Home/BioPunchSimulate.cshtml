@{
  ViewData["Title"] = "Bio-Punch Simulate";
}

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-5 col-md-7">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient text-white text-center py-4"
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h2 class="mb-0 fw-bold">
            <i class="bi bi-fingerprint me-2"></i>Bio-Punch Simulate
          </h2>
        </div>
        <div class="card-body p-5">
          <form asp-action="RecordPunch" method="post">
            <div class="mb-4">
              <label for="EmployeeId" class="form-label fw-semibold text-dark">Proxy Code</label>
              <select class="form-select form-select-lg" id="EmployeeId" name="EmployeeId" required>

              </select>
            </div>

            <div class="mb-4">
              <label for="Timestamp" class="form-label fw-semibold text-dark">Date & Time</label>
              <input type="text" class="form-control form-control-lg" id="Timestamp" name="Timestamp"
                     placeholder="Select date and time" required readonly>
              <input type="hidden" id="TimestampHidden" name="Timestamp">
            </div>

            <div class="d-grid gap-2 mb-3">
              <button type="submit" class="btn btn-lg text-white fw-semibold py-3"
                      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="bi bi-check-circle me-2"></i>Punch In
              </button>
            </div>
          </form>

          <div class="d-grid">
            <a asp-action="Registration" class="btn btn-outline-secondary btn-lg">
              <i class="bi bi-person-plus me-2"></i>Register New Employee
            </a>
          </div>

          @if (TempData["SuccessMessage"] != null)
          {
            <div class="alert alert-success alert-dismissible fade show mt-4" role="alert">
              <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          }

          @if (TempData["ErrorMessage"] != null)
          {
            <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["ErrorMessage"]
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    $(document).ready(function () {
      // Initialize Flatpickr with 12-hour format
      flatpickr('#Timestamp', {
        enableTime: true,
        altInput: true,
        altFormat: "M j, Y h:i K",
        dateFormat: 'Z',
        time_24hr: false,
        defaultDate: new Date(),
      });

      // Initialize Choices.js
      const element = document.getElementById('EmployeeId');
      const choices = new Choices(element, {
        searchEnabled: true,
        duplicateItemsAllowed: false,
        searchFields: ['label'],
        itemSelectText: '',
        shouldSort: false,
        noResultsText: 'No data found',
        noChoicesText: 'No data available'
      });

      let isLoaded = false;

      // Load proxy codes only when dropdown is opened
      element.addEventListener('showDropdown', function () {
        if (!isLoaded) {
          loadProxyCodes();
          isLoaded = true;
        }
      });

      function loadProxyCodes() {
        $.ajax({
          url: '@Url.Action("GetEmployees", "Home")',
          type: 'GET',
          success: function (employees) {
            if (employees && employees.length > 0) {
              const choicesData = employees.map(function (employee) {
                return {
                  value: employee.id.toString(),
                  label: employee.proxyCode
                };
              });

              choices.setChoices(choicesData, 'value', 'label', true);
            }
          },
          error: function () {
            console.error('Failed to load proxy codes');
          }
        });
      }
    });
  </script>
}